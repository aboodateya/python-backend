This was written using a custom context manager.